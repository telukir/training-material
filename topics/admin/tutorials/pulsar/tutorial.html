<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Running Jobs on Remote Resources with Pulsar</title>
        
            <script async defer data-domain="training.galaxyproject.org" src="https://plausible.galaxyproject.eu/js/plausible.js"></script>

        
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

        
        
        
        
        
        <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:title" content="Galaxy Training: Running Jobs on Remote Resources with Pulsar" />
        <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    </head>
    <body data-spy="scroll" data-target="#toc">
        











<!-- Gitter -->


<script>
  ((window.gitter = {}).chat = {}).options = {
  room: 'galaxyproject/admins'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

<header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/training-material/topics/admin" title="Go back to list of tutorials">
                            <i class="far fa-folder" aria-hidden="true"></i><span class="visually-hidden">topic</span> Galaxy Server administration
                        </a>
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Language Selector">
                            <i class="fas fa-language" aria-hidden="true"></i><span class="visually-hidden">language</span> Language
                        </a>
                        <div class="dropdown-menu">
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fpulsar%2Ftutorial.html&edit-text=&act=url" title="">
                                Français
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fpulsar%2Ftutorial.html&edit-text=&act=url" title="">
                                日本語
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fpulsar%2Ftutorial.html&edit-text=&act=url" title="">
                                Español
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fpulsar%2Ftutorial.html&edit-text=&act=url" title="">
                                Português
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fpulsar%2Ftutorial.html&edit-text=&act=url" title="">
                                العربية
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fpulsar%2Ftutorial.html&edit-text=&act=url" title="">
                                And more!
                            </a>
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>

        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQ">
            FAQ
        </a>
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            Discuss on Galaxy Help
        </a>

        <div class="dropdown-item">
            <div>
                Theme
            </div>

            <div id="theme-selector" data-toggle="buttons">
                <label data-value="default" class="btn btn-secondary">
                    <input type="radio" name="options" id="default" autocomplete="off"> Default
                </label>
                <label data-value="night" class="btn btn-secondary">
                    <input type="radio" name="options" id="night" autocomplete="off"> Night
                </label>
                <label data-value="midnight" class="btn btn-secondary">
                    <input type="radio" name="options" id="midnight" autocomplete="off"> Midnight
                </label>
                <label data-value="rainbow" class="btn btn-secondary">
                    <input type="radio" name="options" id="rainbow" autocomplete="off"> Rainbow
                </label>
                <label data-value="halloween" class="btn btn-secondary">
                    <input type="radio" name="options" id="halloween" autocomplete="off"> 🎃
                </label>
                <label data-value="straya" class="btn btn-secondary">
                    <input type="radio" name="options" id="downunder" autocomplete="off"> 🇦🇺
                </label>
            </div>

        </div>
    </div>
</li>


                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/master/topics/admin/tutorials/pulsar/tutorial.md">
                            <i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container main-content">
    <script type="application/ld+json">
        


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Running Jobs on Remote Resources with Pulsar",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "license": "https://github.com/galaxyproject/training-material/blob/master/LICENSE.md",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Galaxy Server administration",
    "description": "Resources related to configuration and maintenance of Galaxy servers",
    "url": "https://training.galaxyproject.org//training-material/topics/admin/"
  },
  "courseCode": "admin / pulsar / hands-on",
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Running Jobs on Remote Resources with Pulsar' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/pulsar/tutorial.html",
  "timeRequired": "PT60M",
  "keywords": "jobs",
  "description": "The questions this  addresses are:\n - How does pulsar work?\n - How can I deploy it?\n\n\\nThe objectives are:\n - Have an understanding of what Pulsar is and how it works\n - Install and configure a RabbitMQ message queueing server\n - Install and configure a Pulsar server on a remote linux machine\n - Be able to get Galaxy to send jobs to a remote Pulsar server\n\n",
  "coursePrerequisites": [
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible/slides.html",
      "name": "Ansible",
      "description": "Slides for 'Ansible' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible/tutorial.html",
      "name": "Ansible",
      "description": "Hands-on for 'Ansible' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible-galaxy/slides.html",
      "name": "Galaxy Installation with Ansible",
      "description": "Slides for 'Galaxy Installation with Ansible' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html",
      "name": "Galaxy Installation with Ansible",
      "description": "Hands-on for 'Galaxy Installation with Ansible' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/connect-to-compute-cluster/slides.html",
      "name": "Connecting Galaxy to a compute cluster",
      "description": "Slides for 'Connecting Galaxy to a compute cluster' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/connect-to-compute-cluster/tutorial.html",
      "name": "Connecting Galaxy to a compute cluster",
      "description": "Hands-on for 'Connecting Galaxy to a compute cluster' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/cvmfs/slides.html",
      "name": "Reference Data with CVMFS",
      "description": "Slides for 'Reference Data with CVMFS' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/cvmfs/tutorial.html",
      "name": "Reference Data with CVMFS",
      "description": "Hands-on for 'Reference Data with CVMFS' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    "A server/VM on which to deploy Pulsar"
  ],
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Simon Gladman"
    },
    {
      "@type": "Person",
      "name": "Marius van den Beek"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Simon Gladman"
    },
    {
      "@type": "Person",
      "name": "Marius van den Beek"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/"
    }
  ]
}
    </script>

    <section class="tutorial">
        <h1 data-toc-skip>Running Jobs on Remote Resources with Pulsar</h1>
        

        <div class="contributors-line">By: 

 <a href="/training-material/hall-of-fame/natefoo/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/natefoo" alt="Nate Coraor">Nate Coraor</a> <a href="/training-material/hall-of-fame/slugger70/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/slugger70" alt="Simon Gladman">Simon Gladman</a> <a href="/training-material/hall-of-fame/mvdbeek/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/mvdbeek" alt="Marius van den Beek">Marius van den Beek</a> <a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/hexylena" alt="Helena Rasche">Helena Rasche</a>

</div>

        <blockquote class="overview">
            <h3>Overview</h3>
            <strong><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Questions</strong>
            <ul>
            
            <li><p>How does pulsar work?</p>
</li>
            
            <li><p>How can I deploy it?</p>
</li>
            
            </ul>

            <strong><i class="fas fa-bullseye" aria-hidden="true"></i><span class="visually-hidden">objectives</span> Objectives</strong>
            <ul>
            
            <li><p>Have an understanding of what Pulsar is and how it works</p>
</li>
            
            <li><p>Install and configure a RabbitMQ message queueing server</p>
</li>
            
            <li><p>Install and configure a Pulsar server on a remote linux machine</p>
</li>
            
            <li><p>Be able to get Galaxy to send jobs to a remote Pulsar server</p>
</li>
            
            </ul>

            
            <strong><i class="fas fa-check-circle" aria-hidden="true"></i><span class="visually-hidden">requirements</span> Requirements</strong>
            <ul>
            
            
    <li>
    
        
        
        <a href="/training-material/topics/admin">Galaxy Server administration</a>
        
            <ul>
                
                    
                        
                    
                        
                    
                        
                            
                            <li> Ansible:
                            
                                <a href="/training-material/topics/admin/tutorials/ansible/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/ansible/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Galaxy Installation with Ansible:
                            
                                <a href="/training-material/topics/admin/tutorials/ansible-galaxy/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Connecting Galaxy to a compute cluster:
                            
                                <a href="/training-material/topics/admin/tutorials/connect-to-compute-cluster/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/connect-to-compute-cluster/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Reference Data with CVMFS:
                            
                                <a href="/training-material/topics/admin/tutorials/cvmfs/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/cvmfs/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
            </ul>
        
    
    </li>

    <li>
    
        A server/VM on which to deploy Pulsar
    
    </li>

            </ul>
            

            
            <p><strong><i class="fas fa-hourglass-half" aria-hidden="true"></i><span class="visually-hidden">time</span> Time estimation:</strong> 60 minutes</p>
            

            

            
            

            
            <p id="supporting-materials"><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials</strong></p>
            <ul>
                <div class="supporting_material">
                
                    <li class="btn btn-default"><a href="/training-material/topics/admin/tutorials/pulsar/slides.html" title="Slides for this tutorial">
                        <i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> Slides
                    </a></li>
                

                

                

                

                
                </div>
            </ul>
            

            <p><strong> <i class="far fa-calendar" aria-hidden="true"></i><span class="visually-hidden">last_modification</span> Last modification:</strong> Jan 21, 2021 </p>
        </blockquote>

        <div class="container">
            <div class="row">
                <!-- sidebar, which will move to the top on a small screen -->
                <div class="col-sm-2">
                    <nav id="toc" data-toggle="toc" class="sticky-top"></nav>
                </div>
                <div class="col-sm-10">
                    <h1 class="no_toc" id="overview">Overview</h1>

<p>Pulsar is the <span class="notranslate">Galaxy</span> Project’s remote job running system. It was written by John Chilton (<a href="https://github.com/jmchilton">@jmchilton</a>) of the <span class="notranslate">Galaxy</span> Project. It is a python server application that can accept jobs from a <span class="notranslate">Galaxy</span> server, submit them to a local resource and then send the results back to the originating <span class="notranslate">Galaxy</span> server.</p>

<p>More details on Pulsar can be found at:</p>

<ul>
  <li><a href="https://pulsar.readthedocs.io/en/latest/index.html">Pulsar’s Documentation</a></li>
  <li><a href="https://github.com/galaxyproject/pulsar">Pulsar’s Github Repository</a></li>
  <li><a href="https://github.com/galaxyproject/ansible-pulsar">Pulsar Ansible Role</a></li>
</ul>

<p>Transport of data, tool information and other metadata can be configured as a web application via a RESTful interface or using a message passing system such as RabbitMQ.</p>

<p>At the <span class="notranslate">Galaxy</span> end, it is configured within the <code class="language-plaintext highlighter-rouge">job_conf.xml</code> file and uses one of two special <span class="notranslate">Galaxy</span> job runners.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.jobs.runners.pulsar:PulsarRESTJobRunner</code> for the RESTful interface</li>
  <li><code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.jobs.runners.pulsar:PulsarMQJobRunner</code> for the message passing interface.</li>
</ul>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

<ol id="markdown-toc">
  <li><a href="#overview-1" id="markdown-toc-overview-1">Overview</a></li>
  <li><a href="#install-and-configure-a-message-queueing-system" id="markdown-toc-install-and-configure-a-message-queueing-system">Install and configure a message queueing system</a>    <ol>
      <li><a href="#installing-the-roles" id="markdown-toc-installing-the-roles">Installing the roles</a></li>
      <li><a href="#configuring-rabbitmq" id="markdown-toc-configuring-rabbitmq">Configuring RabbitMQ</a></li>
      <li><a href="#add-rabbitmq-configuration-to-galaxy-vm" id="markdown-toc-add-rabbitmq-configuration-to-galaxy-vm">Add RabbitMQ configuration to <span class="notranslate">Galaxy</span> VM.</a></li>
    </ol>
  </li>
  <li><a href="#installing-and-configuring-pulsar-on-a-remote-machine" id="markdown-toc-installing-and-configuring-pulsar-on-a-remote-machine">Installing and configuring Pulsar on a remote machine</a>    <ol>
      <li><a href="#configuring-pulsar" id="markdown-toc-configuring-pulsar">Configuring Pulsar</a></li>
    </ol>
  </li>
  <li><a href="#configuring-galaxy-to-use-pulsar-as-a-job-destination" id="markdown-toc-configuring-galaxy-to-use-pulsar-as-a-job-destination">Configuring <span class="notranslate">Galaxy</span> to use Pulsar as a job destination</a></li>
  <li><a href="#testing-pulsar" id="markdown-toc-testing-pulsar">Testing Pulsar</a></li>
  <li><a href="#pulsar-in-production" id="markdown-toc-pulsar-in-production">Pulsar in Production</a>    <ol>
      <li><a href="#australia" id="markdown-toc-australia">Australia</a></li>
      <li><a href="#europe" id="markdown-toc-europe">Europe</a></li>
    </ol>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

</blockquote>

<p>This tutorial assumes that you have:</p>

<ul>
  <li>A VM or machine where you will install Pulsar, and a directory in which the installation will be done. This tutorial assumes it is <code class="language-plaintext highlighter-rouge">/mnt</code></li>
  <li>That you have completed the “<span class="notranslate">Galaxy</span> Installation with Ansible” and CVMFS tutorials (Job configuration tutorial is optional) and have access to the VM/computer where it is installed.</li>
</ul>

<h1 id="overview-1">Overview</h1>

<p>We will be installing the RabbitMQ server daemon onto the <span class="notranslate">Galaxy</span> server to act as an intermediary message passing system between <span class="notranslate">Galaxy</span> and the remote Pulsar. The figure below shows a schematic representation of the system.</p>

<figure id="figure-1"><img src="../../images/pulsar_amqp_schema.png" alt="Schematic diagram of Galaxy communicating with a Pulsar server via the RabbitMQ server" /><figcaption><span class="figcaption-prefix">Figure 1:</span> Schematic diagram of <span class="notranslate">Galaxy</span> communicating with a Pulsar server via the RabbitMQ server. Red arrows represent AMQP communications and blue represent file transfers (initiated by the Pulsar server.)</figcaption></figure>

<p><strong>How it will work:</strong></p>

<ol>
  <li><span class="notranslate">Galaxy</span> will send a message to the RabbitMQ server on the Pulsar server’s particular queue saying that there is a job to be run and then will monitor the queue for job status updates.</li>
  <li>The Pulsar server monitors this queue and when the job appears it will take control of it.</li>
  <li>The Pulsar server will then download the required data etc. from the <span class="notranslate">Galaxy</span> server using <code class="language-plaintext highlighter-rouge">curl</code>.</li>
  <li>The Pulsar server will install any required tools/tool dependencies using Conda.</li>
  <li>The Pulsar server will start running the job using it’s local mechanism and will send a message to the “queue” stating that the job has started.</li>
  <li>Once the job has finished running, the Pulsar server will send a message to the queue stating that the job has finished.</li>
  <li>Pulsar then sends the output data etc. back to the <span class="notranslate">Galaxy</span> server by <code class="language-plaintext highlighter-rouge">curl</code> again.</li>
  <li>The <span class="notranslate">Galaxy</span> server acknowledges the job status and closes the job.</li>
</ol>

<p><strong>Some notes:</strong></p>

<ul>
  <li>RabbitMQ uses the Advanced Message Queueing Protocol (AMQP) to communicate with both the <span class="notranslate">Galaxy</span> server and the remote Pulsar VM.</li>
  <li>Transport of files, meta-data etc. occur via <code class="language-plaintext highlighter-rouge">curl</code> from the Pulsar end.</li>
  <li>RabbitMQ is written in erlang and does not add much overhead to the <span class="notranslate">Galaxy</span> VM, although in larger installations, RabbitMQ is commonly installed on a separate VM to <span class="notranslate">Galaxy</span>. e.g. <span class="notranslate">Galaxy</span> Europe, <span class="notranslate">Galaxy</span> Main and <span class="notranslate">Galaxy</span> Australia.</li>
</ul>

<blockquote class="tip">
  <h3 id="tip-tip-other-file-transport-methods-for-pulsar"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> Tip: Other file transport methods for Pulsar</h3>

  <p>Pulsar can use a variety of file transport methods including:</p>
  <ul>
    <li>Default: <span class="notranslate">Galaxy</span> initiates file transfer and stages files to Pulsar via http transfer.
      <ul>
        <li>This requires that a http transfer port be open on the remote Pulsar.</li>
      </ul>
    </li>
    <li>Remote transfer: Pulsar initiates file transfer. This can use a variety of lso available and can use a variety of methods:
      <ul>
        <li>Curl</li>
        <li>Rsync</li>
        <li>Http</li>
      </ul>
    </li>
  </ul>

  <p>We use remote transfer using <strong>Curl</strong> here so we don’t need an open port on the Pulsar server and tranfer robustness respectively.</p>

</blockquote>

<blockquote class="details">
  <h3 id="details-why-are-we-using-pulsar-in-mq-mode-here-and-not-the-restful-interface"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Why are we using Pulsar in MQ mode here and not the RESTful interface?</h3>
  <p>We are teaching you to install Pulsar and configure it in MQ mode in this tutorial. Configuring Pulsar in RESTful mode is also possible and is quite useful in certain situations. However, in the most common situation MQ mode is preferable for a number of reasons:</p>
  <ul>
    <li>When running Pulsar in RESTful mode, all of the job control and data transfer is controlled by the <span class="notranslate">Galaxy</span> server usually using http transfers. This can place a limit on the size of files that can be transferred without constant configuring of the webserver.</li>
    <li>When running in RESTful mode, Pulsar also needs to have an https server such as nginx, including securing it, configuring it, getting certificates and opening ports. This can be very difficult to do if you are attempting to submit jobs to an institutional HPC where the admins probably won’t let you do any of these things.</li>
    <li>In MQ mode, you only need to open a port for the RabbitMQ server on a machine you are more likely to control. The HPC side running Pulsar can just connect back to you.</li>
  </ul>

  <p>See the <a href="https://pulsar.readthedocs.io/en/latest/">Pulsar documentation</a> for details.</p>
</blockquote>

<h1 id="install-and-configure-a-message-queueing-system">Install and configure a message queueing system</h1>

<p>In this section we will install the RabbitMQ server on your <span class="notranslate">Galaxy</span> server VM.</p>

<p>RabbitMQ is an AMQP server that can queue messages between systems for all sorts of reasons. Here, we will be using the queue so that <span class="notranslate">Galaxy</span> and Pulsar can communicate jobs, job status and job metadata between them easily and robustly. More information on RabbitMQ can be found <a href="https://www.rabbitmq.com/">on their website</a>.</p>

<h2 id="installing-the-roles">Installing the roles</h2>

<p>Firstly we will add and configure another <em>role</em> to our <span class="notranslate">Galaxy</span> playbook - we maintain a slightly modified version of <code class="language-plaintext highlighter-rouge">jasonroyle.rabbitmq</code> to support python3 and other minor updates. Additionally we will use the <span class="notranslate">Galaxy</span> community role for deploying Pulsar</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-install-the-ansible-roles"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Install the Ansible roles</h3>

  <ol>
    <li>
      <p>From your ansible working directory, edit the <code class="language-plaintext highlighter-rouge">requirements.yml</code> file and add the following lines:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">use<span class="notranslate">galaxy</span>_eu.rabbitmq</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">0.1.0</span>
<span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s"><span class="notranslate">galaxy</span>project.pulsar</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">1.0.6</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Now install it with:</p>

      <blockquote class="code-in">
        <h3 id="code-in-input-bash"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-<span class="notranslate">galaxy</span> <span class="nb">install</span> <span class="nt">-p</span> roles <span class="nt">-r</span> requirements.yml
</code></pre></div>        </div>
      </blockquote>
    </li>
  </ol>

</blockquote>

<h2 id="configuring-rabbitmq">Configuring RabbitMQ</h2>

<p>We need to configure RabbitMQ to be able to handle Pulsar messages. To do this we will need to create some queues, Rabbit users, some queue vhosts and set some passwords. We also need to configure rabbit to listen on various interfaces and ports.</p>

<h3 id="defining-virtual-hosts">Defining Virtual Hosts</h3>

<p>Each set of queues in RabbitMQ are grouped and accessed via virtual hosts. We need to create one of these for the transactions between the <span class="notranslate">Galaxy</span> server and Pulsar server. They are set as an array under the <code class="language-plaintext highlighter-rouge">rabbitmq_vhosts</code> variable.</p>

<h3 id="defining-users">Defining users</h3>

<p>Users need to be defined, given passwords and access to the various queues. We will need to create a user that can access this vhost. We will also create an admin user. The queue will need access to the Pulsar queue vhost. They are set as an array under the <code class="language-plaintext highlighter-rouge">rabbitmq_users</code> variable with the following structure:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rabbitmq_users</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">user</span><span class="pi">:</span> <span class="s">use<span class="notranslate">rna</span>me</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">somelongpasswordstring</span>
    <span class="na">vhost</span><span class="pi">:</span> <span class="s">/vhostname</span>
</code></pre></div></div>

<p>Optional: You can add tags to each user if required. e.g. For an admin user it could be useful to add in a <em>administrator</em> tag. These tags allow you to grant permissions to every user with a specific tag.</p>

<h3 id="rabbitmq-server-config">RabbitMQ server config</h3>

<p>We also need to set some RabbitMQ server configuration variables. Such as where its security certificates are and which ports to listen on (both via localhost and network).</p>

<blockquote class="tip">
  <h3 id="tip-port-accessibility-is-important"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> Port accessibility is important!</h3>
  <p>We will need to make sure that the RabbitMQ default port is open and accessible on the server we are installing RabbitMQ onto. (In our case this is the <span class="notranslate">Galaxy</span> server). Default port number is: <code class="language-plaintext highlighter-rouge">5671</code></p>
</blockquote>

<p>More information about the rabbitmq ansible role can be found <a href="https://github.com/usegalaxy-eu/ansible-role-rabbitmq">in the repository</a>.</p>

<h2 id="add-rabbitmq-configuration-to-galaxy-vm">Add RabbitMQ configuration to <span class="notranslate">Galaxy</span> VM.</h2>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-add-rabbitmq-settings-to-galaxy-vm-groupvars-file"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Add RabbitMQ settings to <span class="notranslate">Galaxy</span> VM groupvars file.</h3>

  <ol>
    <li>
      <p>Create or edit the file <code class="language-plaintext highlighter-rouge">group_vars/all.yml</code> and set your private token:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rabbitmq_password_<span class="notranslate">galaxy</span>_au</span><span class="pi">:</span> <span class="s">areallylongpasswordhere</span>
</code></pre></div>      </div>

      <p>This is going in a special file because both of our services, <span class="notranslate">Galaxy</span> and Pulsar, need it. Both <span class="notranslate">Galaxy</span> in the job configuration, and Pulsar in its configuration. The <code class="language-plaintext highlighter-rouge">group_vars/all.yml</code> is included for every playbook run, no matter which group a machine belong to.</p>

      <p>Replace <code class="language-plaintext highlighter-rouge">areallylongpasswordhere</code> with a long randomish (or not) string.</p>
    </li>
    <li>
      <p>From your ansible working directory, edit the <code class="language-plaintext highlighter-rouge">group_vars/<span class="notranslate">galaxy</span>servers.yml</code> file and add make the following changes.</p>

      <div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">--- a/group_vars/<span class="notranslate">galaxy</span>servers.yml
</span><span class="gi">+++ b/group_vars/<span class="notranslate">galaxy</span>servers.yml
</span><span class="p">@@ -81,6 +81,7 @@</span> certbot_environment: staging
 certbot_well_known_root: /srv/nginx/_well-known_root
 certbot_share_key_users:
   - nginx
<span class="gi">+  - rabbitmq
</span> certbot_post_renewal: |
     systemctl restart nginx || true
<span class="gi">+    systemctl restart rabbitmq-server || true
</span> certbot_domains:
<span class="p">@@ -100,3 +101,29 @@</span> nginx_ssl_role: use<span class="notranslate">galaxy</span>_eu.certbot
 nginx_conf_ssl_certificate: /etc/ssl/certs/fullchain.pem
 nginx_conf_ssl_certificate_key: /etc/ssl/user/privkey-nginx.pem

+# RabbitMQ
<span class="gi">+rabbitmq_admin_password: a-different-long-password
+rabbitmq_version: 3.8.9-1
+rabbitmq_plugins: rabbitmq_management
+
+rabbitmq_config:
+- rabbit:
+  - tcp_listeners:
+    - "'127.0.0.1'": 5672
+  - ssl_listeners:
+    - "'0.0.0.0'": 5671
+  - ssl_options:
+     - cacertfile: /etc/ssl/certs/fullchain.pem
+     - certfile: /etc/ssl/certs/cert.pem
+     - keyfile: /etc/ssl/user/privkey-rabbitmq.pem
+     - fail_if_no_peer_cert: 'false'
+
+rabbitmq_vhosts:
+  - /pulsar/<span class="notranslate">galaxy</span>_au
+
+rabbitmq_users:
+  - user: admin
+    password: "{{ rabbitmq_admin_password }}"
+    tags: administrator
+    vhost: /
+  - user: <span class="notranslate">galaxy</span>_au
+    password: "{{ rabbitmq_password_<span class="notranslate">galaxy</span>_au }}"  #This password is set in group_vars/all.yml
+    vhost: /pulsar/<span class="notranslate">galaxy</span>_au
</span></code></pre></div>      </div>
    </li>
    <li>
      <p>Update the <span class="notranslate">Galaxy</span> playbook to include the <em>use<span class="notranslate">galaxy</span>_eu.rabbitmq</em> role.</p>

      <div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">--- a/<span class="notranslate">galaxy</span>.yml
</span><span class="gi">+++ b/<span class="notranslate">galaxy</span>.yml
</span><span class="p">@@ -25,4 +26,3 @@</span>
     - use<span class="notranslate">galaxy</span>_eu.<span class="notranslate">galaxy</span>_systemd
<span class="gi">+    - use<span class="notranslate">galaxy</span>_eu.rabbitmq
</span>     - <span class="notranslate">galaxy</span>project.nginx
</code></pre></div>      </div>

      <blockquote class="tip">
        <h3 id="tip-why-is-this-at-the-end"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> Why is this at the end?</h3>
        <p>This is one of the constant problems with Ansible, how do you order everything correctly? Does an ordering exist such that a single run of the playbook will have everything up and working? We encounter one such instance of this problem now.</p>

        <p>Here are the dependencies between the roles:</p>

        <table>
          <thead>
            <tr>
              <th>From</th>
              <th>To</th>
              <th>Purpose</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>nginx</td>
              <td><span class="notranslate">galaxy</span></td>
              <td>The nginx templates depend on variables only available after the <span class="notranslate">Galaxy</span> role is run</td>
            </tr>
            <tr>
              <td>SSL certificates</td>
              <td>nginx</td>
              <td>A running nginx is required</td>
            </tr>
            <tr>
              <td>RabbitMQ</td>
              <td>SSL certificates</td>
              <td>RabbitMQ will silently start with incorrect configuration if SSL certificates are not present at boot time.</td>
            </tr>
            <tr>
              <td><span class="notranslate">Galaxy</span></td>
              <td>RabbitMQ</td>
              <td><span class="notranslate">Galaxy</span> needs the RabbitMQ available to submit jobs.</td>
            </tr>
          </tbody>
        </table>

        <p>And as you can see there is a circular dependency. <span class="notranslate">Galaxy</span> requires RabbitMQ, but RabbitMQ depends on a long chain of things that depends finally on <span class="notranslate">Galaxy</span>.</p>

        <p>There are some mitigating factors, some software will start with incomplete configuration. We can rely on <span class="notranslate">Galaxy</span> retrying access to RabbitMQ if it isn’t already present. Additionally on first run, <span class="notranslate">Galaxy</span> is restarted by a handler which runs at the end. (Except that the nginx role triggers all pending handlers as part of the SSL certificate deployment.)</p>

        <p>We try to present the optimal version here but due to these interdependencies and Ansible specifics, sometimes it is not possible to determine a good ordering of roles, and multiple runs might be required.</p>

      </blockquote>
    </li>
    <li>
      <p>Run the playbook.</p>

      <blockquote class="code-in">
        <h3 id="code-in-input-bash-1"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook <span class="notranslate">galaxy</span>.yml
</code></pre></div>        </div>
      </blockquote>
    </li>
  </ol>

  <p>The rabbitmq server daemon will have been installed on your <span class="notranslate">Galaxy</span> VM. Check that it’s running now:</p>

  <blockquote class="code-in">
    <h3 id="code-in-input-bash-2"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl status rabbitmq-server
</code></pre></div>    </div>
  </blockquote>

  <blockquote class="code-out code-max-300">
    <h3 id="code-out-output-bash"><i class="fas fa-laptop-code" aria-hidden="true"></i><span class="visually-hidden">code-out</span> Output: Bash</h3>

    <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">●</span> <span class="err">rabbitmq-server.service</span> <span class="err">-</span> <span class="err">RabbitMQ</span> <span class="err">broker</span>
     <span class="err">Loaded:</span> <span class="err">loaded</span> <span class="err">(/lib/systemd/system/rabbitmq-server.service</span><span class="c">; enabled; vendor preset: enabled)
</span>     <span class="err">Active:</span> <span class="err">active</span> <span class="err">(running)</span> <span class="err">since</span> <span class="err">Fri</span> <span class="err">2020-12-18</span> <span class="err">13:52:14</span> <span class="err">UTC</span><span class="c">; 8min ago
</span>   <span class="err">Main</span> <span class="err">PID:</span> <span class="err">533733</span> <span class="err">(beam.smp)</span>
     <span class="err">Status:</span> <span class="err">"Initialized"</span>
      <span class="err">Tasks:</span> <span class="err">163</span> <span class="err">(limit:</span> <span class="err">19175)</span>
     <span class="err">Memory:</span> <span class="err">105.3M</span>
     <span class="err">CGroup:</span> <span class="err">/system.slice/rabbitmq-server.service</span>
             <span class="err">├─533733</span> <span class="err">/usr/lib/erlang/erts-11.1.4/bin/beam.smp</span> <span class="err">-W</span> <span class="err">w</span> <span class="err">-K</span> <span class="err">true</span> <span class="err">-A</span> <span class="err">128</span> <span class="err">-MBas</span> <span class="err">ageffcbf</span> <span class="err">-MHas</span> <span class="err">ageffcbf</span> <span class="err">-MBlmbcs</span> <span class="err">512</span> <span class="err">-MHlmbcs</span> <span class="err">512</span> <span class="err">-MMmcs</span> <span class="err">30</span> <span class="err">-P</span> <span class="err">1048576</span> <span class="err">-t</span> <span class="err">5000000</span> <span class="err">-stbt</span> <span class="err">db</span> <span class="err">-zdbbl</span> <span class="err">1280&gt;</span>
             <span class="err">├─533923</span> <span class="err">erl_child_setup</span> <span class="err">32768</span>
             <span class="err">├─533969</span> <span class="err">/usr/lib/erlang/erts-11.1.4/bin/epmd</span> <span class="err">-daemon</span>
             <span class="err">├─534002</span> <span class="err">inet_gethost</span> <span class="err">4</span>
             <span class="err">└─534003</span> <span class="err">inet_gethost</span> <span class="err">4</span>

<span class="err">Dec</span> <span class="err">18</span> <span class="err">13:52:10</span> <span class="err">gat-0.training.<span class="notranslate">galaxy</span>project.eu</span> <span class="err">rabbitmq-server</span><span class="nn">[533733]</span><span class="err">:</span>   <span class="c">##########  Licensed under the MPL 2.0. Website: https://rabbitmq.com
</span><span class="err">Dec</span> <span class="err">18</span> <span class="err">13:52:10</span> <span class="err">gat-0.training.<span class="notranslate">galaxy</span>project.eu</span> <span class="err">rabbitmq-server</span><span class="nn">[533733]</span><span class="err">:</span>   <span class="err">Doc</span> <span class="err">guides:</span> <span class="err">https://rabbitmq.com/documentation.html</span>
<span class="err">Dec</span> <span class="err">18</span> <span class="err">13:52:10</span> <span class="err">gat-0.training.<span class="notranslate">galaxy</span>project.eu</span> <span class="err">rabbitmq-server</span><span class="nn">[533733]</span><span class="err">:</span>   <span class="err">Support:</span>    <span class="err">https://rabbitmq.com/contact.html</span>
<span class="err">Dec</span> <span class="err">18</span> <span class="err">13:52:10</span> <span class="err">gat-0.training.<span class="notranslate">galaxy</span>project.eu</span> <span class="err">rabbitmq-server</span><span class="nn">[533733]</span><span class="err">:</span>   <span class="err">Tutorials:</span>  <span class="err">https://rabbitmq.com/getstarted.html</span>
<span class="err">Dec</span> <span class="err">18</span> <span class="err">13:52:10</span> <span class="err">gat-0.training.<span class="notranslate">galaxy</span>project.eu</span> <span class="err">rabbitmq-server</span><span class="nn">[533733]</span><span class="err">:</span>   <span class="err">Monitoring:</span> <span class="err">https://rabbitmq.com/monitoring.html</span>
<span class="err">Dec</span> <span class="err">18</span> <span class="err">13:52:10</span> <span class="err">gat-0.training.<span class="notranslate">galaxy</span>project.eu</span> <span class="err">rabbitmq-server</span><span class="nn">[533733]</span><span class="err">:</span>   <span class="err">Logs:</span> <span class="err">/var/log/rabbitmq/rabbit@gat-0.log</span>
<span class="err">Dec</span> <span class="err">18</span> <span class="err">13:52:10</span> <span class="err">gat-0.training.<span class="notranslate">galaxy</span>project.eu</span> <span class="err">rabbitmq-server</span><span class="nn">[533733]</span><span class="err">:</span>         <span class="err">/var/log/rabbitmq/rabbit@gat-0_upgrade.log</span>
<span class="err">Dec</span> <span class="err">18</span> <span class="err">13:52:10</span> <span class="err">gat-0.training.<span class="notranslate">galaxy</span>project.eu</span> <span class="err">rabbitmq-server</span><span class="nn">[533733]</span><span class="err">:</span>   <span class="err">Config</span> <span class="err">file(s):</span> <span class="err">(none)</span>
<span class="err">Dec</span> <span class="err">18</span> <span class="err">13:52:14</span> <span class="err">gat-0.training.<span class="notranslate">galaxy</span>project.eu</span> <span class="err">rabbitmq-server</span><span class="nn">[533733]</span><span class="err">:</span>   <span class="err">Starting</span> <span class="err">broker...</span> <span class="err">completed</span> <span class="err">with</span> <span class="err">0</span> <span class="err">plugins.</span>
<span class="err">Dec</span> <span class="err">18</span> <span class="err">13:52:14</span> <span class="err">gat-0.training.<span class="notranslate">galaxy</span>project.eu</span> <span class="err">systemd</span><span class="nn">[1]</span><span class="err">:</span> <span class="err">Started</span> <span class="err">RabbitMQ</span> <span class="err">broker.</span>
</code></pre></div>    </div>
  </blockquote>

  <p>But this doesn’t tell the whole story, so run the diagnostics command to
   check that the interfaces are setup and listening. RabbitMQ has a bad
   habit of silently failing when processing the configuration, without any
   logging information If RabbitMQ has any problem reading the configuration
   file, it falls back to the default configuration (listens <em>without</em> ssl on
   <code class="language-plaintext highlighter-rouge">tcp/5672</code>) so be sure to check that everything is OK before continuing.</p>

  <blockquote class="code-in">
    <h3 id="code-in-input-bash-3"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>rabbitmq-diagnostics status
</code></pre></div>    </div>
  </blockquote>

  <blockquote class="code-out code-max-300">
    <h3 id="code-out-output-bash-1"><i class="fas fa-laptop-code" aria-hidden="true"></i><span class="visually-hidden">code-out</span> Output: Bash</h3>

    <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">...</span>

<span class="err">Listeners</span>

<span class="err">Interface:</span> <span class="nn">[::]</span><span class="err">,</span> <span class="err">port:</span> <span class="err">15672,</span> <span class="err">protocol:</span> <span class="err">http,</span> <span class="err">purpose:</span> <span class="err">HTTP</span> <span class="err">API</span>
<span class="err">Interface:</span> <span class="nn">[::]</span><span class="err">,</span> <span class="err">port:</span> <span class="err">25672,</span> <span class="err">protocol:</span> <span class="err">clustering,</span> <span class="err">purpose:</span> <span class="err">inter-node</span> <span class="err">and</span> <span class="err">CLI</span> <span class="err">tool</span> <span class="err">communication</span>
<span class="err">Interface:</span> <span class="nn">[::]</span><span class="err">,</span> <span class="err">port:</span> <span class="err">5672,</span> <span class="err">protocol:</span> <span class="err">amqp,</span> <span class="err">purpose:</span> <span class="err">AMQP</span> <span class="err">0-9-1</span> <span class="err">and</span> <span class="err">AMQP</span> <span class="err">1.0</span>
<span class="err">Interface:</span> <span class="err">0.0.0.0,</span> <span class="err">port:</span> <span class="err">5671,</span> <span class="err">protocol:</span> <span class="err">amqp/ssl,</span> <span class="err">purpose:</span> <span class="err">AMQP</span> <span class="err">0-9-1</span> <span class="err">and</span> <span class="err">AMQP</span> <span class="err">1.0</span> <span class="err">over</span> <span class="err">TLS</span>
</code></pre></div>    </div>
  </blockquote>

  <p>But wait! There are more ways it can go wrong. To be extra sure, run a quick <code class="language-plaintext highlighter-rouge">curl</code> command.</p>

  <blockquote class="code-in">
    <h3 id="code-in-input-bash-4"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://localhost:5672
curl <span class="nt">-k</span> https://localhost:5671
</code></pre></div>    </div>
  </blockquote>

  <blockquote class="code-out code-max-300">
    <h3 id="code-out-output-bash-2"><i class="fas fa-laptop-code" aria-hidden="true"></i><span class="visually-hidden">code-out</span> Output: Bash</h3>

    <p>These should <em>both</em> report the same response:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">curl: (1) Received HTTP/0.9 when not allowed
</span></code></pre></div>    </div>

    <p>if they don’t, consider the following debugging steps:</p>

    <ol>
      <li>Restarting RabbitMQ</li>
      <li>Check that the configuration looks correct (ssl private key path looks valid)</li>
      <li>Check that the private key is shared correctly with the rabbitmq user</li>
    </ol>
  </blockquote>

</blockquote>

<h1 id="installing-and-configuring-pulsar-on-a-remote-machine">Installing and configuring Pulsar on a remote machine</h1>

<p>Now that we have a message queueing system running on our <span class="notranslate">Galaxy</span> VM, we need to install and configure Pulsar on our remote compute VM. To do this we need to create a new ansible playbook to install Pulsar.</p>

<h2 id="configuring-pulsar">Configuring Pulsar</h2>

<p>From the <a href="https://github.com/galaxyproject/ansible-pulsar#role-variables"><code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>project.pulsar</code> ansible role documentation</a>, we need to specify some variables.</p>

<p>There is one required variable:</p>

<p><code class="language-plaintext highlighter-rouge">pulsar_server_dir</code> - The location in which to install pulsar</p>

<p>Then there are a lot of optional variables. They are listed here for information. We will set some for this tutorial but not all.</p>

<table>
  <thead>
    <tr>
      <th>Variable Name</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pulsar_yaml_config</code></td>
      <td>a YAML dictionary whose contents will be used to create Pulsar’s <code class="language-plaintext highlighter-rouge">app.yml</code></td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pulsar_venv_dir</code></td>
      <td>The role will create a virtualenv from which Pulsar will run</td>
      <td><code class="language-plaintext highlighter-rouge">&lt;pulsar_server_dir&gt;/venv</code> if installing via pip, <code class="language-plaintext highlighter-rouge">&lt;pulsar_server_dir&gt;/.venv</code> if not.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pulsar_config_dir</code></td>
      <td>Directory that will be used for Pulsar configuration files.</td>
      <td><code class="language-plaintext highlighter-rouge">&lt;pulsar_server_dir&gt;/config</code> if installing via pip, <code class="language-plaintext highlighter-rouge">&lt;pulsar_server_dir&gt;</code> if not</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pulsar_optional_dependencies</code></td>
      <td>List of optional dependency modules to install, depending on which features you are enabling.</td>
      <td><code class="language-plaintext highlighter-rouge">None</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pulsar_install_environments</code></td>
      <td>Installing dependencies may require setting certain environment variables to compile successfully.</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pulsar_create_user</code></td>
      <td>Should a user be created for running pulsar?</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pulsar_user</code></td>
      <td>Define the user details</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>Some of the other options we will be using are:</p>

<ul>
  <li>
    <p>We will set the tool dependencies to rely on <strong>conda</strong> for tool installs.</p>
  </li>
  <li>
    <p>You will need to know the FQDN or IP address of the <span class="notranslate">Galaxy</span> server VM that you installed RabbitMQ on.</p>
  </li>
</ul>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-configure-pulsar-group-variables"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Configure pulsar group variables</h3>

  <ol>
    <li>
      <p>Create a new file in <code class="language-plaintext highlighter-rouge">group_vars</code> called <code class="language-plaintext highlighter-rouge">pulsarservers.yml</code> and set some of the above variables as well as some others.</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na"><span class="notranslate">galaxy</span>_server_url</span><span class="pi">:</span> <span class="c1"># Important!!!</span>
<span class="c1"># Put your <span class="notranslate">Galaxy</span> server's fully qualified domain name (FQDN) (or the FQDN of the RabbitMQ server) above.</span>

<span class="na">pulsar_root</span><span class="pi">:</span> <span class="s">/mnt/pulsar</span>

<span class="na">pulsar_pip_install</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">pulsar_pycurl_ssl_library</span><span class="pi">:</span> <span class="s">openssl</span>
<span class="na">pulsar_systemd</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">pulsar_systemd_runner</span><span class="pi">:</span> <span class="s">webless</span>

<span class="na">pulsar_create_user</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">pulsar_user</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">name</span><span class="pi">:</span> <span class="nv">pulsar</span><span class="pi">,</span> <span class="nv">shell</span><span class="pi">:</span> <span class="nv">/bin/bash</span><span class="pi">}</span>

<span class="na">pulsar_optional_dependencies</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">pyOpenSSL</span>
  <span class="c1"># For remote transfers initiated on the Pulsar end rather than the <span class="notranslate">Galaxy</span> end</span>
  <span class="pi">-</span> <span class="s">pycurl</span>
  <span class="c1"># drmaa required if connecting to an exte<span class="notranslate">rna</span>l DRM using it.</span>
  <span class="pi">-</span> <span class="s">drmaa</span>
  <span class="c1"># kombu needed if using a message queue</span>
  <span class="pi">-</span> <span class="s">kombu</span>
  <span class="c1"># amqp 5.0.3 changes behaviour in an unexpected way, pin for now.</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">amqp==5.0.2'</span>
  <span class="c1"># psutil and pylockfile are optional dependencies but can make Pulsar</span>
  <span class="c1"># more robust in small ways.</span>
  <span class="pi">-</span> <span class="s">psutil</span>

<span class="na">pulsar_yaml_config</span><span class="pi">:</span>
  <span class="na">conda_auto_init</span><span class="pi">:</span> <span class="s">True</span>
  <span class="na">conda_auto_install</span><span class="pi">:</span> <span class="s">True</span>
  <span class="na">staging_directory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">pulsar_staging_dir</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">persistence_directory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">pulsar_persistence_dir</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">tool_dependency_dir</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">pulsar_dependencies_dir</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="c1"># The following are the settings for the pulsar server to contact the message queue with related timeouts etc.</span>
  <span class="na">message_queue_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">pyamqp://<span class="notranslate">galaxy</span>_au:{{</span><span class="nv"> </span><span class="s">rabbitmq_password_<span class="notranslate">galaxy</span>_au</span><span class="nv"> </span><span class="s">}}@{{</span><span class="nv"> </span><span class="s"><span class="notranslate">galaxy</span>_server_url</span><span class="nv"> </span><span class="s">}}:5671//pulsar/<span class="notranslate">galaxy</span>_au?ssl=1"</span>
  <span class="na">min_polling_interval</span><span class="pi">:</span> <span class="m">0.5</span>
  <span class="na">amqp_publish_retry</span><span class="pi">:</span> <span class="s">True</span>
  <span class="na">amqp_publish_retry_max_retries</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">amqp_publish_retry_interval_start</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">amqp_publish_retry_interval_step</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">amqp_publish_retry_interval_max</span><span class="pi">:</span> <span class="m">60</span>

<span class="c1"># We also need to create the dependency resolver file so pulsar knows how to</span>
<span class="c1"># find and install dependencies for the tools we ask it to run. The simplest</span>
<span class="c1"># method which covers 99% of the use cases is to use conda auto installs similar</span>
<span class="c1"># to how <span class="notranslate">Galaxy</span> works.</span>
<span class="na">pulsar_dependency_resolvers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">conda</span>
    <span class="na">args</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">auto_init</span>
        <span class="na">value</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div>      </div>

      <blockquote class="details">
        <h3 id="details-running-non-conda-tools"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Running non-conda tools</h3>
        <p>If the tool you want to run on Pulsar doesn’t have a conda package, you will need to make alte<span class="notranslate">rna</span>tive arrangements! This is complex and beyond our scope here. See the <a href="https://pulsar.readthedocs.io/en/latest/">Pulsar documentation</a> for details.</p>
      </blockquote>
    </li>
    <li>
      <p>Add the following lines to your <code class="language-plaintext highlighter-rouge">hosts</code> file:</p>

      <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[pulsarservers]</span>
<span class="err">&lt;ip_address</span> <span class="err">or</span> <span class="err">fqdn</span> <span class="err">of</span> <span class="err">your</span> <span class="err">pulsar</span> <span class="err">server&gt;</span> <span class="py">ansible_user</span><span class="p">=</span><span class="s">&lt;use<span class="notranslate">rna</span>me to login with&gt;</span>
</code></pre></div>      </div>
    </li>
  </ol>

</blockquote>

<p>We will now write a new playbook for the pulsar installation as we are going to install it on a separate VM. We will also install the CVMFS client and the <span class="notranslate">Galaxy</span> CVMFS repos on this machine so Pulsar has the same access to reference data that <span class="notranslate">Galaxy</span> does.</p>

<p>We need to include a couple of pre-tasks to install virtualenv, git, etc.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-creating-the-playbook"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Creating the playbook</h3>

  <ol>
    <li>
      <p>Create a <code class="language-plaintext highlighter-rouge">pulsar.yml</code> file with the following contents:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">pulsarservers</span>
  <span class="na">pre_tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install some packages</span>
      <span class="na">package</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">build-essential</span>
          <span class="pi">-</span> <span class="s">git</span>
          <span class="pi">-</span> <span class="s">python3-dev</span>
          <span class="pi">-</span> <span class="s">libcurl4-openssl-dev</span>
          <span class="pi">-</span> <span class="s">libssl-dev</span>
          <span class="pi">-</span> <span class="s">virtualenv</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">present</span>
        <span class="na">update_cache</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">role</span><span class="pi">:</span> <span class="s"><span class="notranslate">galaxy</span>project.cvmfs</span>
      <span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="pi">-</span> <span class="s"><span class="notranslate">galaxy</span>project.pulsar</span>
</code></pre></div>      </div>

      <p>There are a couple of <em>pre-tasks</em> here. This is because we need to install some base packages on these very vanilla ubuntu instances as well as give ourselves ownership of the directory we are installing into.</p>
    </li>
  </ol>

</blockquote>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-run-the-playbook"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Run the Playbook</h3>

  <ol>
    <li>
      <p>Run the playbook.</p>

      <blockquote class="code-in">
        <h3 id="code-in-input-bash-5"><i class="far fa-keyboard" aria-hidden="true"></i><span class="visually-hidden">code-in</span> Input: Bash</h3>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook pulsar.yml
</code></pre></div>        </div>
      </blockquote>

      <p>After the script has run, pulsar will be installed on the remote machines!</p>

      <blockquote class="tip">
        <h3 id="tip-connection-issues"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> Connection issues?</h3>
        <p>If your remote pulsar machine uses a different key, you may need to supply the <code class="language-plaintext highlighter-rouge">ansible-playbook</code> command with the private key for the connection using the <code class="language-plaintext highlighter-rouge">--private-key key.pem</code> option.</p>
      </blockquote>
    </li>
    <li>
      <p>Log in to the machines and have a look in the <code class="language-plaintext highlighter-rouge">/mnt/pulsar</code> directory. You will see the venv and config directories. All the config files created by Ansible can be perused.</p>
    </li>
    <li>
      <p>Run <code class="language-plaintext highlighter-rouge">jou<span class="notranslate">rna</span>lctl -f -u pulsar</code></p>

      <p>A log will now start scrolling, showing the startup of pulsar. You’ll notice that it will be initializing and installing conda. Once this is completed, Pulsar will be listening on the assigned port.</p>
    </li>
  </ol>

</blockquote>

<h1 id="configuring-galaxy-to-use-pulsar-as-a-job-destination">Configuring <span class="notranslate">Galaxy</span> to use Pulsar as a job destination</h1>

<p>Now we have a Pulsar server up and running, we need to tell our <span class="notranslate">Galaxy</span> about it.</p>

<p><span class="notranslate">Galaxy</span> talks to the Pulsar server via it’s <code class="language-plaintext highlighter-rouge">job_conf.xml</code> file. We need to let <span class="notranslate">Galaxy</span> know about Pulsar there and make sure <span class="notranslate">Galaxy</span> has loaded the requisite job runner, and has a destination set up.</p>

<p>There are three things we need to do here:</p>

<ul>
  <li>We will need to create a job runner which uses the  <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.jobs.runners.pulsar:PulsarMQJobRunner</code> code.</li>
  <li>Create job destination which references the above job runner.</li>
  <li>Tell <span class="notranslate">Galaxy</span> which tools to send to the job destination: We will use <code class="language-plaintext highlighter-rouge">bwa-mem</code></li>
</ul>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-configure-galaxy"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Configure <span class="notranslate">Galaxy</span></h3>

  <ol>
    <li>
      <p>In your <code class="language-plaintext highlighter-rouge">templates/<span class="notranslate">galaxy</span>/config/job_conf.xml.j2</code> file add the following job runner to the <code class="language-plaintext highlighter-rouge">&lt;plugins&gt;</code> section:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin</span> <span class="na">id=</span><span class="s">"pulsar_runner"</span> <span class="na">type=</span><span class="s">"runner"</span> <span class="na">load=</span><span class="s">"<span class="notranslate">galaxy</span>.jobs.runners.pulsar:PulsarMQJobRunner"</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"amqp_url"</span><span class="nt">&gt;</span>pyamqp://<span class="notranslate">galaxy</span>_au:{{ rabbitmq_password_<span class="notranslate">galaxy</span>_au }}@localhost:5671/{{ rabbitmq_vhosts[0] }}?ssl=1<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"amqp_ack_republish_time"</span><span class="nt">&gt;</span>1200<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"amqp_acknowledge"</span><span class="nt">&gt;</span>True<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"amqp_consumer_timeout"</span><span class="nt">&gt;</span>2.0<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"amqp_publish_retry"</span><span class="nt">&gt;</span>True<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"amqp_publish_retry_max_retries"</span><span class="nt">&gt;</span>60<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"<span class="notranslate">galaxy</span>_url"</span><span class="nt">&gt;</span>https://{{ inventory_hostname }}<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"manager"</span><span class="nt">&gt;</span>_default_<span class="nt">&lt;/param&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div>      </div>

      <p>Add the following to the <code class="language-plaintext highlighter-rouge">&lt;destinations&gt;</code> section of your <code class="language-plaintext highlighter-rouge">job_conf.xml</code> file:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;destination</span> <span class="na">id=</span><span class="s">"pulsar"</span> <span class="na">runner=</span><span class="s">"pulsar_runner"</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"default_file_action"</span><span class="nt">&gt;</span>remote_transfer<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"dependency_resolution"</span><span class="nt">&gt;</span>remote<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"jobs_directory"</span><span class="nt">&gt;</span>/mnt/pulsar/files/staging<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"persistence_directory"</span><span class="nt">&gt;</span>/mnt/pulsar/files/persisted_data<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"remote_metadata"</span><span class="nt">&gt;</span>False<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"rewrite_parameters"</span><span class="nt">&gt;</span>True<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"transport"</span><span class="nt">&gt;</span>curl<span class="nt">&lt;/param&gt;</span>
<span class="nt">&lt;/destination&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Finally we need to tell <span class="notranslate">Galaxy</span> which tools to send to Pulsar. We will tell it to send bwa-mem jobs to it. We use the <code class="language-plaintext highlighter-rouge">&lt;tools&gt;</code> section of the <code class="language-plaintext highlighter-rouge">job_conf.xml</code> file.
We need to know the full id of the tool in question, we can get this out of the <code class="language-plaintext highlighter-rouge">integrated_tool_panel.xml</code> file in the <code class="language-plaintext highlighter-rouge">mutable-config</code> directory. Then we tell <span class="notranslate">Galaxy</span> which destination to send it to (pulsar).</p>

      <p>Add the following to the end of the <code class="language-plaintext highlighter-rouge">job_conf.xml</code> file (inside the <code class="language-plaintext highlighter-rouge">&lt;tools&gt;</code> section if it exists or create it if it doesn’t.)</p>

      <div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">--- a/templates/<span class="notranslate">galaxy</span>/config/job_conf.xml.j2
</span><span class="gi">+++ b/templates/<span class="notranslate">galaxy</span>/config/job_conf.xml.j2
</span><span class="p">@@ -35,6 +35,7 @@</span>

     &lt;/destinations&gt;
     &lt;tools&gt;
<span class="gi">+        &lt;tool id="bwa" destination="pulsar"/&gt;
+        &lt;tool id="bwa_mem" destination="pulsar"/&gt;
</span>     &lt;/tools&gt;
 &lt;/job_conf&gt;
</code></pre></div>      </div>

      <p>You can use the full tool ID here (<span class="notranslate">toolshed</span>.g2.bx.psu.edu/repos/devteam/bwa/bwa/0.7.17.4), or the short version. By using the full version, we restrict to only running that specific version in pulsar.</p>
    </li>
    <li>
      <p>Install <code class="language-plaintext highlighter-rouge">bwa</code> from the admin installation interface if it is missing.</p>

      <ol>
        <li>Access the admin menu from the top bar (only available if logged in with the admin_user email)</li>
        <li>Click “Install and Uninstall”, which can be found on the left, under “Tool Management”</li>
        <li>Enter <code class="language-plaintext highlighter-rouge">bwa</code> in the search interface</li>
        <li>Click on the first hit, from <code class="language-plaintext highlighter-rouge">devteam</code></li>
        <li>Click the “Install” button for the latest version and enter “<span class="notranslate">Mapping</span>” for the target section.</li>
      </ol>
    </li>
    <li>
      <p>Run the <span class="notranslate">Galaxy</span> playbook in order to deploy the updated job configuration, and to restart <span class="notranslate">Galaxy</span>.</p>
    </li>
  </ol>

</blockquote>

<h1 id="testing-pulsar">Testing Pulsar</h1>

<p>Now we will upload a small set of data to run bwa-mem with.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-testing-the-pulsar-destination"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Testing the Pulsar destination</h3>

  <ol>
    <li>
      <p>Upload the following files from zenodo.</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://zenodo.org/record/582600/files/mutant_R1.fastq
https://zenodo.org/record/582600/files/mutant_R2.fastq
</code></pre></div>      </div>
    </li>
    <li>
      <p><strong>Map with BWA-MEM</strong> <i class="fas fa-wrench" aria-hidden="true"></i><span class="visually-hidden">tool</span> with the following parameters</p>
      <ul>
        <li><em>“Will you select a reference genome from your history or use a built-in index”</em>: <code class="language-plaintext highlighter-rouge">Use a built-in genome index</code></li>
        <li><em>“Using reference genome”</em>: <code class="language-plaintext highlighter-rouge">Escherichia coli (str. K-12 substr MG1655): eschColi_K12</code></li>
        <li><em>“Single or Paired-end <span class="notranslate">reads</span>”</em>: <code class="language-plaintext highlighter-rouge">Paired end</code></li>
        <li><i class="far fa-file" aria-hidden="true"></i><span class="visually-hidden">param-file</span> <em>“Select first set of <span class="notranslate">reads</span>”</em>: <code class="language-plaintext highlighter-rouge">mutant_R1.fastq</code></li>
        <li><i class="far fa-file" aria-hidden="true"></i><span class="visually-hidden">param-file</span> <em>“Select second set of <span class="notranslate">reads</span>”</em>: <code class="language-plaintext highlighter-rouge">mutant_R2.fastq</code></li>
      </ul>

      <p>As soon as you press <em>execute</em> <span class="notranslate">Galaxy</span> will send the job to the pulsar server. You can watch the log in <span class="notranslate">Galaxy</span> using:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jou<span class="notranslate">rna</span>lctl -fu <span class="notranslate">galaxy</span>
</code></pre></div>      </div>

      <p>You can watch the log in Pulsar by ssh’ing to it and tailing the log file with:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jou<span class="notranslate">rna</span>lctl -fu pulsar
</code></pre></div>      </div>
    </li>
  </ol>

</blockquote>

<p>You’ll notice that the Pulsar server has received the job (all the way in Australia!) and now should be installing bwa-mem via conda. Once this is complete (which may take a while - first time only) the job will run. When it starts running it will realise it needs the <em>E. coli</em> genome from CVMFS and fetch that, and then results will be returned to <span class="notranslate">Galaxy</span>!</p>

<p>How awesome is that? Pulsar in another continent with reference data automatically from CVMFS :)</p>

<h1 id="pulsar-in-production">Pulsar in Production</h1>

<p>If you want to make use of Pulsar on a Supercomputer, you only need access to a submit node, and you will need to run Pulsar there. We recommend that if you need to run a setup with Pulsar, that you deploy an AMQP server (e.g. RabbitMQ) alongside your <span class="notranslate">Galaxy</span>. That way, you can run Pulsar on any submit nodes, and it can connect directly to the AMQP and <span class="notranslate">Galaxy</span>. Other Pulsar deployment options require exposing ports wherever Pulsar is running, and this requires significant more coordination effort.</p>

<p>For each new Pulsar server, you will need to add:</p>
<ol>
  <li>In the RabbitMQ config:
    <ul>
      <li>A vhost</li>
      <li>A user - configured with a password and the new vhost</li>
    </ul>
  </li>
  <li>In the <span class="notranslate">Galaxy</span> job_conf.xml:
    <ul>
      <li>A new job runner with the new connection string</li>
      <li>A new destination or multiple destinations for the new runner.</li>
    </ul>
  </li>
</ol>

<p>Pulsar servers can be the head node of a cluster. You can create a cluster and use your favourite job scheduler such as Slurm or PBS to schedule jobs. You can have many destinations in your <span class="notranslate">Galaxy</span> job_conf.xml file that change the number of cpus, amount of RAM etc. It can get quite complex and flexible if you like.</p>

<h2 id="australia">Australia</h2>

<p>You can also create multiple queues on your RabbitMQ server for multiple Pulsar servers. On <span class="notranslate">Galaxy</span> Australia, we run 5 different Pulsar servers spread out all around the country. They all communicate with <span class="notranslate">Galaxy</span> via the one RabbitMQ server.</p>

<p><img src="../../images/pulsar_australia.png" alt="Map of australia with 6 pulsar nodes marked around the country." /></p>

<h2 id="europe">Europe</h2>

<p><span class="notranslate">Galaxy</span> Europe has taken Pulsar and built <a href="https://pulsar-network.readthedocs.io/en/latest">The Pulsar Network</a>. This provides a framework for easily deploying Pulsar clusters in the cloud, something needed to support compute centers which might not have as much experience. This way they get an easy package they can deploy and the European <span class="notranslate">Galaxy</span> team can manage.</p>

<p><img src="https://pulsar-network.readthedocs.io/en/latest/_images/nodes.png" alt="Map of europe with pulsar nodes marked in many countries. An inset shows australia with a node there too." /></p>

<p>The main purpose of this network is to support the workload of the Use<span class="notranslate">Galaxy</span>.eu instance by distributing it across several European data centers and clusters. If you’re interested in setting up something similar, they <a href="https://pulsar-network.readthedocs.io/en/latest/introduction.html">provide documentation</a> on how to install and configure a Pulsar network endpoint on a cloud infrastructure and how to connect it to your server.</p>

<h1 id="conclusion">Conclusion</h1>

<p>You’re ready to ship your <span class="notranslate">Galaxy</span> jobs around the world! Now wherever you have compute space, you know how to setup a Pulsar node and connect it to <span class="notranslate">Galaxy</span>. Let us know if you come up with creative places to run your <span class="notranslate">Galaxy</span> jobs (coworker’s laptops, your IoT fridge, the sky is the limit if it’s x86 and has python)</p>


                    
                    <blockquote class="key_points">
                        <h3><i class="fas fa-key" aria-hidden="true"></i><span class="visually-hidden">keypoints</span> Key points</h3>
                        <ul>
                            
                            <li><p>Pulsar allows you to easily add geographically distributed compute resources into your Galaxy instance</p>
</li>
                            
                            <li><p>It also works well in situations where the compute resources cannot share storage pools.</p>
</li>
                            
                        </ul>
                    </blockquote>
                    

                    

                    

                    <h1>Feedback</h1>
                    <p class="text-muted">Did you use this material as an instructor? Feel free to give us feedback on <a href="https://github.com/galaxyproject/training-material/issues/1452" target="_blank">how it went</a>.</p>

                    <div id="feedback-button">
                        <img src="/training-material/shared/images/feedback.png" title="Click to activate" alt="Click here to load Google feedback frame" />
                    </div>
                    <div id="feedback-form">
                    </div>
                    <script type="text/javascript">
                        (function (window, document) {
                            function onDocumentReady(fn) {
                                if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
                                    fn();
                                } else {
                                    document.addEventListener('DOMContentLoaded', fn);
                                }
                            }

                            onDocumentReady(function () {
                                $("#feedback-button").click(function(evt){
                                    var e = $(evt.target)
                                    e.hide();

                                    $("#feedback-form").html(`
                                        <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Running Jobs on Remote Resources with Pulsar (Galaxy Server administration)">Loading...</iframe>
                                    `)
                                })
                            });
                        })(window, document);
                    </script>



                    <h1>Citing this Tutorial</h1>
                    <p>
                        <ol>
                            <li id="citation-text">Nate Coraor, Simon Gladman, Marius van den Beek, Helena Rasche, 2021 <b>Running Jobs on Remote Resources with Pulsar (Galaxy Training Materials)</b>. <a href="/training-material/topics/admin/tutorials/pulsar/tutorial.html">/training-material/topics/admin/tutorials/pulsar/tutorial.html</a> Online; accessed TODAY
                            </li>
                            <li>
                            Batut et al., 2018 <b>Community-Driven Data Analysis Training for Biology</b> Cell Systems <a href="https://doi.org/10.1016%2Fj.cels.2018.05.012">10.1016/j.cels.2018.05.012</a>
                            </li>
                        </ol>
                    </p>


                    <blockquote class="details">
                      <h3><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> BibTeX</h3>
                      <p style="display: none;">

                    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight">
<code id="citation-code">@misc{admin-pulsar,
    author = "Nate Coraor and Simon Gladman and Marius van den Beek and Helena Rasche",
    title = "Running Jobs on Remote Resources with Pulsar (Galaxy Training Materials)",
    year = "2021",
    month = "01",
    day = "21"
    url = "\url{/training-material/topics/admin/tutorials/pulsar/tutorial.html}",
    note = "[Online; accessed TODAY]"
}
@article{Batut_2018,
        doi = {10.1016/j.cels.2018.05.012},
        url = {https://doi.org/10.1016%2Fj.cels.2018.05.012},
        year = 2018,
        month = {jun},
        publisher = {Elsevier {BV}},
        volume = {6},
        number = {6},
        pages = {752--758.e1},
        author = {B{\'{e}}r{\'{e}}nice Batut and Saskia Hiltemann and Andrea Bagnacani and Dannon Baker and Vivek Bhardwaj and Clemens Blank and Anthony Bretaudeau and Loraine Brillet-Gu{\'{e}}guen and Martin {\v{C}}ech and John Chilton and Dave Clements and Olivia Doppelt-Azeroual and Anika Erxleben and Mallory Ann Freeberg and Simon Gladman and Youri Hoogstrate and Hans-Rudolf Hotz and Torsten Houwaart and Pratik Jagtap and Delphine Larivi{\`{e}}re and Gildas Le Corguill{\'{e}} and Thomas Manke and Fabien Mareuil and Fidel Ram{\'{\i}}rez and Devon Ryan and Florian Christoph Sigloch and Nicola Soranzo and Joachim Wolff and Pavankumar Videm and Markus Wolfien and Aisanjiang Wubuli and Dilmurat Yusuf and James Taylor and Rolf Backofen and Anton Nekrutenko and Björn Grüning},
        title = {Community-Driven Data Analysis Training for Biology},
        journal = {Cell Systems}
}</code>
                    </pre></div></div>
                    </p>
                    </blockquote>


<script type="text/javascript">
// update the date on load, or leave fallback of 'today'
d = new Date();
document.getElementById("citation-code").innerHTML = document.getElementById("citation-code").innerHTML.replace("TODAY", d.toDateString());
document.getElementById("citation-text").innerHTML = document.getElementById("citation-text").innerHTML.replace("TODAY", d.toDateString());
</script>

                </div>
            </div>
        </div>

        <h3><i class="far fa-thumbs-up" aria-hidden="true"></i><span class="visually-hidden">congratulations</span> Congratulations on successfully completing this tutorial!</h3>

        

        
    </section>
</div>


<footer>
    <div class="container">
        <p>
            This material is the result of a collaborative work. Thanks to the
            <a href="https://wiki.galaxyproject.org/Teach/GTN">Galaxy Training Network</a>
            and all the <a href="/training-material/hall-of-fame">contributors</a> (Nate Coraor, Simon Gladman, Marius van den Beek, Helena Rasche)!
        </p>
        <p>
            Found a typo? Something is wrong in this tutorial? Edit it on
            <a href="https://github.com/galaxyproject/training-material/tree/master/topics/admin/tutorials/pulsar/tutorial.md">GitHub</a>.
        </p>
        <p>
    The content of the tutorials and website is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
</p>
    </div>
</footer>

    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>

    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
    var snippets=document.querySelectorAll('div.highlight');
    [].forEach.call(snippets,function(snippet){
        snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
    });

    var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.nextElementSibling;
    }});
    </script>
    

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('div.container.main-content').prepend("<div class='alert alert-warning'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>
</html>
